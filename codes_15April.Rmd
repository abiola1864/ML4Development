---
title: "R Notebook"
output: html_notebook
---

############
#note
#################


#These codes are used to download DHS data for Tanzania, Rwanda, and Uganda
#from the DHS R package called RDHS, then merged with geocovariates data
#sourced online via URL links of each. Final data saved as csv as finaldata
#and added to Github

#From the RDHS package, I am able download specific variables rather than the whole
#DHS data. For now, variables on maternal mortality are not available using
#variable names that starts with mm e.g mm1, mm2. I will keep checking.

#For an easy check of other variable names and labels, use WorldBank library at
#https://microdata.worldbank.org/index.php/catalog/2597/data-dictionary/F1?file_name=RECH0

#Variables downloaded are age of HH member, anemia level for child, father and mother
# and their body mass.

#for geocovariates, there are GPS coordinates, cluster ID, nightlight composite





#install libraries


```{r}

```


if (!require("rdhs")) stop("Reading RDHS data into R requires the ipumsr package. It can be installed using the following command: install.packages('rdhs')")
library(rdhs)# Make an api request
library(dplyr) # data manipulation
library(data.table) #for unlisting data

# find all the surveys that fit our search criteria
survs <- dhs_datasets(
  #surveyCharacteristicIds = 15,
  countryIds = c("RW","TZ", "UG"),
  #surveyType = "DHS",
  #indicatorIds = "MM_MMRT_W_PDT",
  surveyYearStart = 2010,
  surveyYearEnd = 2019,
 fileFormat = "Flat",
  fileType = c('PR') #Household Member Recode
  )
  

1
## set up your credentials
set_rdhs_config(email = "vishalisairam@gmail.com",
                project = "Built Environment and Outcomes",
                config_path = "~/.rdhs.json",
                cache_path = "project_th",
                global = TRUE)

# download datasets
downloads <- get_datasets(survs$FileName,
                          clear_cache = TRUE)


# and grab the questions from this now utilising the survey variables
vars <- search_variables(dataset_filenames = names(downloads),
                               variables = c( #"hv001", 
                               #"hv002",
                               #"hv003",
                               "hv201",
                               "ha57", 
                               "hc11",
"hv204",
"hv205",
"hv206",
"hv207",
"hv208",
"hv209",
"hv210",
"hv211",
"hv212",
"hv213",
"hv214",
"hv215",
"hv216",
"hv219",
"hv221",
"hv225",
"hv226",
"hv227",
"hv228",
"hv230a",
"hv230b",
"hv237",
"hv238",
"hv243a",
"hv242",
"hv247",
"hv252",
"hv271",
"hv270",
"hml1"))
                                                          )  
#extract data
extract <- extract_dhs(vars, add_geo = TRUE)


#unlist data and rename variables to be used for merging
dat<-rbindlist(extract, use.names=TRUE, fill=TRUE) %>% as.data.frame()
dat1 <- rbind_labelled(dat) %>% 
  rename (DHSCLUST = 'CLUSTER') %>% 
  rename (SurveyID = 'SurveyId')



########################
#GPS COVARIATES
########################


#since RDHS does not give GPS covariates, at least from my efforts at the moment
#we get them from their URL in spatialdata.dhsprogram.con


#################
#Rwanda GPS covariates (2010, 2015)
#################
temp <- tempfile()
download.file("https://spatialdata.dhsprogram.com/utility-api/SDR/covariates/production/internal/RW/RWGC62FL.ZIP",temp, mode="wb")
unzip(temp, "RWGC62FL.csv")
rwand2010 <- read.table("RWGC62FL.csv", sep=",", header=T)

download.file("https://spatialdata.dhsprogram.com/utility-api/SDR/covariates/production/internal/RW/RWGC72FL.ZIP",temp, mode="wb")
unzip(temp, "RWGC72FL.csv")
rwand2015 <- read.table("RWGC72FL.csv", sep=",", header=T)

#row merge all Rwanda
rwanda_all<- rbind(rwand2015)

#################
#Tanzania GPS covariates (2010, 2012, 2015, 2017)
#################

uga2016 <- subset(uga2016[,c(1:51, 58:130)])

rwa2015 <- subset(rwand2015[,c(1:51, 57:131)])


download.file("https://spatialdata.dhsprogram.com/utility-api/SDR/covariates/production/internal/TZ/TZGC7BFL.ZIP",temp, mode="wb")
unzip(temp, "TZGC7BFL.csv")
tan2015 <- read.table("TZGC7BFL.csv", sep=",", header=T)



finaldata2 <- subset(finaldata1[, -c(18,24,26)])




#row merge all Tanzania
tan_all<- rbind(tan2010,tan2012,tan2015,tan2017)


#################
#Uganda GPS covariates (2011, 2014, 2016, 2018)
#################




download.file("https://spatialdata.dhsprogram.com/utility-api/SDR/covariates/production/internal/UG/UGGC7BFL.ZIP",temp, mode="wb")
unzip(temp, "UGGC7BFL.csv")
uga2016 <- read.table("UGGC7BFL.csv", sep=",", header=T)



#row merge all uganda

uga_all<- rbind(uga2011,uga2014,uga2016,uga2018)


#################
#merge all countries
geocov<- rbind(tan2015,rwand2015)

  
  
#################
## Merge DHS data + GEO COVARIATES
#################
# select important covariates, including nightlife composite 
geocov1<- geocov[c(1:6,77)]


# merge by SurveyID and DHSCLUST
finaldata<-inner_join(dat1,geocov,
             by =  c('SurveyID', "DHSCLUST"))

# write CSV file
write.csv(finaldata, "/Users/vishali/Desktop/SPRING 2021/project-ml/finaldata/new.csv")


# subset data

finaldata1 <- subset(finaldata[,-c(17,22:22,31,32,45,46,48,49,52,53,55,56,57,59:61,63:65, 67:72, 73, 75, 76, 77, 83, 84, 86, 87, 88, 90, 91, 92:94, 95, 96, 97, 99, 100, 101, 103, 104, 105, 107, 108, 109, 111, 112, 113, 116, 118, 119, 120, 122, 123, 124, 126, 127, 129, 130, 131, 132, 133, 134, 136, 137, 138, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 154, 156, 158, 159, 160, 162, 163, 164, 166, 167, 168)])


#recode
sum(is.na(finaldata1))




# further removing

finaldata2 <- subset(finaldata1[, -c(18,24,26)])


```{r}
 unlabelled(finaldata$hv201)
finaldata$hv202<- as.numeric(as_factor.labelled(finaldata$hv202))
finaldata$hv205<- as.numeric(as_factor.labelled(finaldata$hv205))
finaldata$hv213<- as.numeric(as_factor.labelled(finaldata$hv213))
finaldata$hv214<- as.numeric(as_factor.labelled(finaldata$hv214))
finaldata$hv215<- as.numeric(as_factor.labelled(finaldata$hv215))
finaldata$hml<- as.numeric(as_factor.labelled(finaldata$hml))
```


```{r}
unlabelled(finaldata2$hv202)
unlabelled(finaldata2$hv205)
unlabelled(finaldata$hv213)
unlabelled(finaldata$hv214)
unlabelled(finaldata$hv215)
unlabelled(finaldata$hml)
```


```{r}
library(naniar) # to remove multiple NAs

na_strings1 <- c(96, 98)
finaldata3 <- finaldata2 %>%
  replace_with_na_at(.vars = c(finaldata2$hv201,
                               finaldata2$hv202,
                               finaldata2$hv205, finaldata2$hv213, finaldata2$hv214, finaldata2$hv215, finaldata2$hm1),
                     condition = ~.x %in% na_strings1)
```

```{r}
finaldata2$hv201 = ifelse(finaldata2$hv201 == 96, NA, finaldata$hv201)
```


```{r}
#finaldata2$hv202 = ifelse(finaldata2$hv202 == 96, NA, finaldata$hv202)
finaldata2$hv205 = ifelse(finaldata2$hv205 == 96, NA, finaldata2$hv205)
finaldata2$hv213 = ifelse(finaldata2$hv213 == 96, NA, finaldata2$hv213)
finaldata2$hv214 = ifelse(finaldata2$hv214 == 96, NA, finaldata2$hv214)
finaldata2$hv215 = ifelse(finaldata2$hv215 == 96, NA, finaldata2$hv215)
finaldata2$hv215 = ifelse(finaldata2$hv215 == 96, NA, finaldata2$hv215)
finaldata2$hml1 = ifelse(finaldata2$hml1 == 98, NA, finaldata2$hml1)
```


# recode

finaldata2$hv201 <-as.factor(finaldata2$hv201)
finaldata2$hv201 <- revalue(finaldata2$hv201, c("11" = "2", "12" = "2", "13" = "2", "21" = "2", "31" = "2", "32" = "1", "41" = "2", "42" = "1", "43" = "1", "51" = "1", "61" = "1", "62" = "1", "99" = "NA"))

finaldata2$hv205 <-as.factor(finaldata2$hv205)
finaldata2$hv205 <- revalue(finaldata2$hv205, c("11" = "2", "12" = "2", "13" = "2", "14" = "2", "15" = "2", "21" = "1", "22" = "1", "23" = "1", "31" = "0", "41" = "0", "42" = "0", "99" = "NA"))

finaldata2$hv213 <-as.factor(finaldata2$hv213)
finaldata2$hv213 <- revalue(finaldata2$hv213, c("11" = "0", "12" = "0", "21" = "1", "22" = "1", "31" = "2", "32" = "2", "33" = "2", "34" = "2", "35" = "2", "99" = "NA"))

finaldata2$hv214 <-as.factor(finaldata2$hv214)
finaldata2$hv214 <- revalue(finaldata2$hv214, c("11" = "0", "12" = "0", "13" = "0", "21" = "1", "22" = "1", "23" = "1", "24" = "1", "25" = "1", "26" = "1", "31" = "2", "32" = "2", "33" = "2","34" = "2", "35" = "2", "36" = "2", "99" = "NA"))

finaldata2$hv215 <-as.factor(finaldata2$hv215)
finaldata2$hv215 <- revalue(finaldata2$hv215, c("11" = "0", "12" = "0", "13" = "0", "21" = "1", "22" = "1", "23" = "1", "24" = "1", "31" = "2", "32" = "2", "33" = "2","34" = "3", "35" = "3", "36" = "3", "99" = "NA")


write.csv(finaldata2, "/Users/vishali/Desktop/SPRING 2021/project-ml/finaldata/new2.csv")
